<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>Dave's Simple Chat Service in Node.js</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <style>
    #header {
      position: fixed;
      top: 0;
      height: 60px;
      width: 100%;
      background: #ffffff;
    }

    #getName {
      padding-top: 30px;
    }

    #messages {
      list-style-type: none;
      margin: 0;
      padding-top: 35px;
      margin-bottom: 35px !important;
      }

    #messages li {
      margin-bottom: 5px !important;
      padding: 5px 10px; }

    #messages li:nth-child(odd) {
      background: #eee; }

    #m {
      width: 300px;
    }

    #sendMessage {
      position: fixed;
      bottom: 0;
      margin-bottom: 0 !important;
      height: 50px;
      /*height: 40px;*/
      background: #ffffff;
      width: 100%;
    }

    #usersOnline {
      color: #8A8A8A;
      padding: 0 0;
      margin-top: -25px;
      margin-bottom: 5px;
    }

    .currentTime {
      display: block;
      float: right;
      color: #909093;
      font-size: .75em;
    }
  </style>

  <!-- Script
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <script src="js/jquery.js"></script>

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="images/favicon.png">

</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container" style="margin-bottom:50px;">
    <div class="row">
      <div class="twelve columns" style="margin-top: 5%">
        <div id="header">
          <h4>Dave's Simple Chat Service</h4>
          <p id="usersOnline"><span id="currentUsers">0 users online</span> | <a href="https://github.com/rockbandit/DaveChat" target="_blank">what's this?</a></p>
        </div>

        <div id="getName">
          <p></p>
          <form id="user">
            <p>What is your username?</p>
            <input id="un" autocomplete="off" />
            <button>Submit Username</button>
          </form>
        </div>

        <div id="messageContainer">
          <p id="messages"></p>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <form id="sendMessage" action="">
      <input id="m" autocomplete="off" />
      <button>Send Message</button>
    </form>
  </div>


<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <script>

    // Try to linkify any proper URL?
    String.prototype.parseURL = function() {
      return this.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g, function(url) {

        var displayURL = url;
        urlCount = url.length;
        // Truncate extra long URLs
        if (url.length > 40) {
          displayURL = url.substring(0,35);
          displayURL = displayURL + "…";
        }

        var newURL = "<a href=\"" + url + "\" target=\"_blank\">" + displayURL + "<a/>";
        return newURL;
        //return url.link(url);
      });
    };

    // Potentially find the beginnings of any URL and then convert stuff.
    function findURL(chatmessage) {
      if (chatmessage.indexOf("http:&#x2F;&#x2F;") != -1) {
        chatmessage = chatmessage.replace(/&#x2F;/g, "/");
      }
      return chatmessage;
    }

    // Create a nice timestamp
    function timeStamp() {
    // Create a date object with the current time
      var now = new Date();

    // Create an array with the current month, day and time
      var date = [ now.getMonth() + 1, now.getDate(), now.getFullYear() ];

    // Create an array with the current hour, minute and second
      var time = [ now.getHours(), now.getMinutes(), now.getSeconds() ];

    // Determine AM or PM suffix based on the hour
      var suffix = ( time[0] < 12 ) ? "AM" : "PM";

    // Convert hour from military time
      time[0] = ( time[0] < 12 ) ? time[0] : time[0] - 12;

    // If hour is 0, set it to 12
      time[0] = time[0] || 12;

    // If seconds and minutes are less than 10, add a zero
      for ( var i = 1; i < 3; i++ ) {
        if ( time[i] < 10 ) {
          time[i] = "0" + time[i];
        }
      }

    // Return the formatted string
      return time.join(":") + " " + suffix;
    }

    // On initial page load, let's use jQuery to hide our
    // message div and the send message form so we can
    // ask for a username first.
    $('#sendMessage').hide();
    $('#messages').hide();

    var socket = io();
    $('#getName').submit(function () {
      socket.emit('username', $('#un').val());
      $('#getName').hide();
      $('#messages').show();
      $('#sendMessage').show();
      document.getElementById("m").focus();
      return false;
    })

    $('#sendMessage').submit(function () {
      socket.emit('chat message', $('#m').val());
      $('#m').val('');
      window.scrollTo(0,document.body.scrollHeight); // Always scroll down to your latest message
      return false;
    });

    socket.on('chat message', function(username, msg){
      var currTime = "<span class=\"currentTime\">" + timeStamp() + "</span>";
      msg = findURL(msg);
      //msg = msg.parseURL;
      console.log(typeof msg);
      $('#messages').append($('<li><strong>' + username + ':</strong> ' + msg + " " + currTime + '</li>'));
    });

    socket.on('user count', function(userCount) {
      $('#currentUsers').html(userCount + " users online");
    })

  </script>
</body>
</html>
